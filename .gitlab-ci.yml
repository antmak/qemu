stages:
  - build
  - deploy

build-linux:
  stage: build
  image: $CI_DOCKER_REGISTRY/qemu-build:6
  tags:
    - build
    - amd64
  artifacts:
    paths:
      - dist/esp-qemu-*.tar.bz2
      - dist/archive_name_*
    expire_in: 1 week
  parallel:
    matrix:
      - PLATFORM: [x86_64-linux-gnu]
        TARGET: [riscv32-linux-user, xtensa-softmmu, riscv32-softmmu]
  script:
    - VERSION=${CI_COMMIT_TAG:-""}
    - VERSION=${VERSION//"-"/"_"}   # replace dashes with underscores in the version
    - VERSION=${VERSION:-${CI_COMMIT_SHORT_SHA}}

    - ./.github/workflows/scripts/prerequisites-native.sh
    - ./.github/workflows/scripts/configure-native.sh
    - ninja -C build install

    - find ./install/qemu/share/qemu -maxdepth 1 -mindepth 1 -not -name 'esp*.bin' -exec rm -rfv {} \;
    - DIST_DIR=${PWD}/dist
    - mkdir -p ${DIST_DIR}
    - cd ./install
    - export ARCHIVE_NAME=qemu-${TARGET}-${VERSION}-${PLATFORM}.tar.bz2
    - tar cjvf ${DIST_DIR}/${ARCHIVE_NAME} qemu
    - echo $ARCHIVE_NAME >${DIST_DIR}/archive_name_${TARGET}_${PLATFORM}

upload_to_http:
  image: espressif/scp
  stage: deploy
  tags:
    - deploy
    - shiny
  when: manual
  allow_failure: true
  variables:
    # don't use "GIT_STRATEGY: none", because we need cleaning old artifacts in 'dist/' that came from previous pipelines
    SSH_KEY: "$HTTP_UPLOAD_KEY" # used inside 'espressif/scp'
  script:
    # List of archives in dist/
    - FILES=$(find dist -name archive_name_\* -exec cat {} \+)
    - cd dist
    - scp ${FILES} ${HTTP_UPLOAD_DIR}
    # Show info
    - /bin/ls -l ${FILES}
    - sha256sum ${FILES}
    - echo -e "\nArchives were published there:\n\n$(for n in ${FILES}; do echo "${HTTP_PUBLIC_DIR}/${n}"; done)\n"

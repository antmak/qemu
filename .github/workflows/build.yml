name: 'build'

on: [push]

jobs:
  x86_64-linux-gnu:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: "noninteractive"
        run: |
          sudo apt-get install -y \
            libgcrypt-dev \
            ninja-build \
          && :
      - name: Configure
        run: |
          ./configure \
            --prefix=$PWD/opt/qemu \
            --static \
            --target-list=xtensa-softmmu \
            --extra-cflags=-Werror \
            --enable-debug \
            --disable-strip \
            --disable-user \
            --disable-capstone \
            --disable-vnc \
            --disable-sdl \
            --disable-gtk \
            --enable-gcrypt \
          && :
      - name: Build
        run: |
          ninja -C build
      - name: Package
        run: |
          ninja -C build install
          find opt/qemu/share/qemu -maxdepth 1 -mindepth 1 -not -name 'esp*.bin' -exec rm -rf {} \;
          cd opt
          tar cxvf qemu-test-111.tar.gz qemu

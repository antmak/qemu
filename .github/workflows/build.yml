name: 'build'

on: [push, pull_request]

jobs:
  # build:
  #   strategy:
  #     matrix:
  #       include:
  #         - platform: macos-x86_64
  #           runs_on: macos-10.15
  #           extra_configure_args: "--disable-cocoa --disable-coreaudio"
  #         - platform: linux-amd64
  #           runs_on: ubuntu-18.04
  #           # Building with -Werror only on Linux as that breaks some features detection
  #           # in meson on macOS.
  #           extra_configure_args: "--extra-cflags=-Werror --disable-gtk"
  #   runs-on: ${{ matrix.runs_on }}
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Install prerequisites (Linux)
  #       if: ${{ matrix.platform == 'linux-amd64' }}
  #       env:
  #         DEBIAN_FRONTEND: "noninteractive"
  #       run: |
  #         sudo apt-get install -y \
  #             binutils-dev \
  #             ninja-build \
  #             libgcrypt-dev \
  #     - name: Install prerequisites (macOS)
  #       if: ${{ matrix.platform == 'macos-x86_64' }}
  #       run: |
  #         brew install \
  #             ninja \
  #             libgcrypt \
  #             glib \
  #             pixman \
  #             pkg-config
  #     - name: Configure
  #       run: |
  #         ./configure \
  #           --prefix=$PWD/install/qemu \
  #           --target-list=xtensa-softmmu \
  #           --enable-gcrypt \
  #           --disable-user \
  #           --disable-capstone \
  #           --disable-vnc \
  #           --disable-sdl \
  #           --disable-docs \
  #           ${{ matrix.extra_configure_args }}
  #     - name: Build
  #       run: |
  #         ninja -C build
  #     - name: Package distribution archive
  #       run: |
  #         ninja -C build install
  #         find install/qemu/share/qemu -maxdepth 1 -mindepth 1 -not -name 'esp*.bin' -exec rm -rf {} \;
  #         mkdir -p dist
  #         export DIST_DIR=${PWD}/dist
  #         export ARCHIVE_NAME=qemu-${{ github.ref_name }}-${{ matrix.platform }}.tar.bz2
  #         cd install
  #         tar cjvf ${DIST_DIR}/${ARCHIVE_NAME} qemu
  #         cd ${DIST_DIR}
  #         shasum -a 256 *.tar.bz2 > ${ARCHIVE_NAME}.sha256

  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: msys2/setup-msys2@v2
        with:
          cache: true
          msystem: mingw64
          install: >-
            mingw-w64-x86_64-python
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-libgcrypt
            mingw-w64-x86_64-libslirp
            diffutils git
      - name: Configure
        shell: msys2 {0}
        env:
          MSYSTEM: MINGW64
          CHERE_INVOKING: 'yes'
          MSYS: 'winsymlinks:native'
          CONFIG_OPTS: --target-list=xtensa-softmmu --disable-capstone --disable-vnc --disable-user --disable-sdl --disable-gtk --enable-gcrypt --enable-slirp
        run: |
          mkdir build
          cd build
          ../configure ${{ env.CONFIG_OPTS }}
      - name: Build
        shell: msys2 {0}
        run: ninja -C build
